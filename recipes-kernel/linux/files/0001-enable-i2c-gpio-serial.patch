From ebfc4f48235ee6ad7fa71359b72ef3673d758672 Mon Sep 17 00:00:00 2001
From: daniel_chan <daniel_chan@accton.com>
Date: Fri, 31 May 2019 14:04:10 +0800
Subject: [PATCH] enable i2c gpio serial.

---
 arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dts | 40 +++++++++++++++++++++-
 arch/arm/configs/bcm2709_defconfig         | 23 ++++++++-----
 2 files changed, 53 insertions(+), 10 deletions(-)

diff --git a/arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dts b/arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dts
index 59dd76c3240d..a923157d2aae 100644
--- a/arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dts
+++ b/arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dts
@@ -19,6 +19,8 @@
 };
 
 &gpio {
+	status = "okay";
+
 	spi0_pins: spi0_pins {
 		brcm,pins = <9 10 11>;
 		brcm,function = <4>; /* alt0 */
@@ -39,6 +41,11 @@
 		brcm,function = <4>;
 	};
 
+	i2sw_pins: i2sw {
+		brcm,pins = <19>; /* i2c switch reset */
+		brcm,function = <1>; /* output */
+	};
+
 	i2s_pins: i2s {
 		brcm,pins = <18 19 20 21>;
 		brcm,function = <4>; /* alt0 */
@@ -72,6 +79,28 @@
 		brcm,pins = <40 41>;
 		brcm,function = <4>;
 	};
+
+	pwm0_gpio12: pwm0_gpio12 {
+		brcm,pins = <12>;
+		brcm,function = <4>;
+	};
+
+	pwm1_gpio13: pwm1_gpio13 {
+		brcm,pins = <13>;
+		brcm,function = <4>;
+	};
+};
+
+&pwm {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pwm0_gpio12 &pwm1_gpio13>;
+	status = "okay";
+	gpio_fan {
+		status = "okay";
+		compatible = "gpio-fan";
+		gpios = <&gpio 20 0>, <&gpio 21 0>, <&gpio 16 0>,<&gpio 26 0>;
+		gpio-fan,speed-map = <0 0 3000 1>;
+	};
 };
 
 &mmc {
@@ -135,8 +164,17 @@
 
 &i2c1 {
 	pinctrl-names = "default";
-	pinctrl-0 = <&i2c1_pins>;
+	pinctrl-0 = <&i2c1_pins &i2sw_pins>;
 	clock-frequency = <100000>;
+	status = "okay";
+	i2cswitch@75 {
+		status = "okay";
+		compatible = "pca9548";
+		#address-cells = <0x1>;
+		#size-cells = <0x0>;
+		reg = <0x75>;
+		reset-gpios = <&gpio 19 1>; /* 0:in, 1:out */
+	};
 };
 
 &i2c2 {
diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
index a2db06f18290..b031e39a7681 100644
--- a/arch/arm/configs/bcm2709_defconfig
+++ b/arch/arm/configs/bcm2709_defconfig
@@ -610,12 +610,14 @@ CONFIG_RAW_DRIVER=y
 CONFIG_TCG_TPM=m
 CONFIG_TCG_TIS_SPI=m
 CONFIG_I2C=y
-CONFIG_I2C_CHARDEV=m
+CONFIG_OF_I2C=y
+CONFIG_I2C_CHARDEV=y
+CONFIG_I2C_MUX=y
 CONFIG_I2C_MUX_GPMUX=m
-CONFIG_I2C_MUX_PCA954x=m
+CONFIG_I2C_MUX_PCA954x=y
 CONFIG_I2C_BCM2708=m
-CONFIG_I2C_BCM2835=m
-CONFIG_I2C_GPIO=m
+CONFIG_I2C_BCM2835=y
+CONFIG_I2C_GPIO=y
 CONFIG_I2C_ROBOTFUZZ_OSIF=m
 CONFIG_I2C_TINY_USB=m
 CONFIG_SPI=y
@@ -658,7 +660,7 @@ CONFIG_BATTERY_DS2760=m
 CONFIG_BATTERY_GAUGE_LTC2941=m
 CONFIG_HWMON=m
 CONFIG_SENSORS_DS1621=m
-CONFIG_SENSORS_GPIO_FAN=m
+CONFIG_SENSORS_GPIO_FAN=y
 CONFIG_SENSORS_JC42=m
 CONFIG_SENSORS_LM75=m
 CONFIG_SENSORS_RPI_POE_FAN=m
@@ -1014,7 +1016,8 @@ CONFIG_USBIP_VHCI_HCD=m
 CONFIG_USBIP_HOST=m
 CONFIG_USBIP_VUDC=m
 CONFIG_USB_DWC2=m
-CONFIG_USB_SERIAL=m
+CONFIG_USB_SERIAL=y
+CONFIG_USB_SERIAL_CONSOLE=y
 CONFIG_USB_SERIAL_GENERIC=y
 CONFIG_USB_SERIAL_AIRCABLE=m
 CONFIG_USB_SERIAL_ARK3116=m
@@ -1025,7 +1028,7 @@ CONFIG_USB_SERIAL_DIGI_ACCELEPORT=m
 CONFIG_USB_SERIAL_CP210X=m
 CONFIG_USB_SERIAL_CYPRESS_M8=m
 CONFIG_USB_SERIAL_EMPEG=m
-CONFIG_USB_SERIAL_FTDI_SIO=m
+CONFIG_USB_SERIAL_FTDI_SIO=y
 CONFIG_USB_SERIAL_VISOR=m
 CONFIG_USB_SERIAL_IPAQ=m
 CONFIG_USB_SERIAL_IR=m
@@ -1062,7 +1065,7 @@ CONFIG_USB_SERIAL_XSENS_MT=m
 CONFIG_USB_SERIAL_WISHBONE=m
 CONFIG_USB_SERIAL_SSU100=m
 CONFIG_USB_SERIAL_QT2=m
-CONFIG_USB_SERIAL_DEBUG=m
+CONFIG_USB_SERIAL_DEBUG=y
 CONFIG_USB_EMI62=m
 CONFIG_USB_EMI26=m
 CONFIG_USB_ADUTUX=m
@@ -1239,7 +1242,9 @@ CONFIG_INV_MPU6050_I2C=m
 CONFIG_TSL4531=m
 CONFIG_VEML6070=m
 CONFIG_BMP280=m
-CONFIG_PWM_BCM2835=m
+CONFIG_PWM=y
+CONFIG_PWM_SYSFS=y
+CONFIG_PWM_BCM2835=y
 CONFIG_PWM_PCA9685=m
 CONFIG_RPI_AXIPERF=m
 CONFIG_RASPBERRYPI_FIRMWARE=y
-- 
2.17.1

